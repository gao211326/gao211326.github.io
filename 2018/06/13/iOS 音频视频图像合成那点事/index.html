<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="One Dream" />



<meta name="description" content="人而无信不知其可  前言很久很久没有写点什么了，只因为最近事情太多了，这几天终于闲下来了，趁此机会，记录下几个月前写的一个关于视频音频图片合成方面的一个小例子 入场先来看看实现的大概功能吧~  由于其它功能不好制作gif，这里就先展示一个简单的水印图片下面就让我们一点点来分析分析">
<meta name="keywords">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS 音频视频图像合成那点事">
<meta property="og:url" content="http://yoursite.com/2018/06/13/iOS 音频视频图像合成那点事/index.html">
<meta property="og:site_name" content="半笑半醉间">
<meta property="og:description" content="人而无信不知其可  前言很久很久没有写点什么了，只因为最近事情太多了，这几天终于闲下来了，趁此机会，记录下几个月前写的一个关于视频音频图片合成方面的一个小例子 入场先来看看实现的大概功能吧~  由于其它功能不好制作gif，这里就先展示一个简单的水印图片下面就让我们一点点来分析分析">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/2525768-03d262810a756a6e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/2525768-cdebd3e14bb569f1.gif?imageMogr2/auto-orient/strip">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/2525768-12edbb419a2e96c1.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/2525768-48338395550fc455.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/2525768-0f052c896cda0e15.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2018-06-13T06:15:23.778Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS 音频视频图像合成那点事">
<meta name="twitter:description" content="人而无信不知其可  前言很久很久没有写点什么了，只因为最近事情太多了，这几天终于闲下来了，趁此机会，记录下几个月前写的一个关于视频音频图片合成方面的一个小例子 入场先来看看实现的大概功能吧~  由于其它功能不好制作gif，这里就先展示一个简单的水印图片下面就让我们一点点来分析分析">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/2525768-03d262810a756a6e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="半笑半醉间" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/orange/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>iOS 音频视频图像合成那点事 | 半笑半醉间</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: undefined
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">One Dream</a></h1>
        </hgroup>

        
        <p class="header-subtitle">人生为棋，我愿为卒，行动虽慢，可谁曾见我后退半步</p>
        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa GitHub" href="https://github.com/gao211326" title="GitHub"></a>
                            
                                <a class="fa 简书" href="http://www.jianshu.com/u/d772826c5def" title="简书"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于前端</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">One Dream</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">One Dream</a></h1>
            </hgroup>
            
            <p class="header-subtitle">人生为棋，我愿为卒，行动虽慢，可谁曾见我后退半步</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/gao211326" title="GitHub"></a>
                            
                                <a class="fa 简书" target="_blank" href="http://www.jianshu.com/u/d772826c5def" title="简书"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap"><article id="post-iOS 音频视频图像合成那点事" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/06/13/iOS 音频视频图像合成那点事/" class="article-date">
      <time datetime="2018-06-12T16:00:00.000Z" itemprop="datePublished">2018-06-13</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      iOS 音频视频图像合成那点事
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <excerpt in="" index="" |="" 首页摘要="">

<blockquote>
<p>人而无信不知其可</p>
</blockquote>
<h5 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h5><p>很久很久没有写点什么了，只因为最近事情太多了，这几天终于闲下来了，趁此机会，记录下几个月前写的一个关于视频音频图片合成方面的一个小例子</p>
<h5 id="入场"><a href="#入场" class="headerlink" title="入场"></a>入场</h5><p>先来看看实现的大概功能吧~</p>
<p><img src="https://upload-images.jianshu.io/upload_images/2525768-03d262810a756a6e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="功能介绍.png"></p>
<p>由于其它功能不好制作gif，这里就先展示一个简单的水印图片<br><img src="https://upload-images.jianshu.io/upload_images/2525768-cdebd3e14bb569f1.gif?imageMogr2/auto-orient/strip" alt="水印.gif"><br>下面就让我们一点点来分析分析</p>
<a id="more"></a>
<the rest="" of="" contents="" |="" 余下全文="">

<h5 id="需要了解什么"><a href="#需要了解什么" class="headerlink" title="需要了解什么"></a>需要了解什么</h5><p>先来看一个关系图，字写的丑，将就着看吧….<br><img src="https://upload-images.jianshu.io/upload_images/2525768-12edbb419a2e96c1.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="IMG_8292.JPG"></p>
<p>看着上面的图，是有点凌乱的感觉，下面我们就一点点来剥开。</p>
<h5 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h5><p>根据需要实现的功能，我这里建了一个类，来分别实现不同的功能<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">@interface VideoAudioComposition : NSObject</div><div class="line"></div><div class="line"></div><div class="line">/**</div><div class="line"> 合成后的名字</div><div class="line"> */</div><div class="line">@property (nonatomic,copy) NSString *compositionName;</div><div class="line"></div><div class="line">/**</div><div class="line"> 合成类型</div><div class="line"> */</div><div class="line">@property (nonatomic,assign) CompositionType compositionType;</div><div class="line"></div><div class="line"></div><div class="line">/**</div><div class="line"> 转换后的格式</div><div class="line"> */</div><div class="line">@property (nonatomic, copy) AVFileType outputFileType;</div><div class="line"></div><div class="line"></div><div class="line">/**</div><div class="line"> 进度block</div><div class="line"> */</div><div class="line">@property (nonatomic,copy)CompositionProgress progressBlock;</div><div class="line"></div><div class="line">/**</div><div class="line"> 视频音频合成</div><div class="line"></div><div class="line"> @param videoUrl 视频地址</div><div class="line"> @param videoTimeRange 截取时间</div><div class="line"> @param audioUrl 音频地址</div><div class="line"> @param audioTimeRange 截取时间</div><div class="line"> @param successBlcok 成功回调</div><div class="line"> */</div><div class="line">- (void)compositionVideoUrl:(NSURL *)videoUrl videoTimeRange:(CMTimeRange)videoTimeRange audioUrl:(NSURL *)audioUrl audioTimeRange:(CMTimeRange)audioTimeRange success:(SuccessBlcok)successBlcok;</div><div class="line"></div><div class="line"></div><div class="line">/**</div><div class="line"> 视频和视频合成</div><div class="line"></div><div class="line"> @param videoUrl 视频地址</div><div class="line"> @param videoTimeRange 截取时间</div><div class="line"> @param mergeVideoUrl 视频地址</div><div class="line"> @param mergeVideoTimeRange 截取时间</div><div class="line"> @param successBlcok 成功回调</div><div class="line"> */</div><div class="line">- (void)compositionVideoUrl:(NSURL *)videoUrl videoTimeRange:(CMTimeRange)videoTimeRange mergeVideoUrl:(NSURL *)mergeVideoUrl mergeVideoTimeRange:(CMTimeRange)mergeVideoTimeRange success:(SuccessBlcok)successBlcok;</div><div class="line"></div><div class="line"></div><div class="line">/**</div><div class="line"> 多个音频合成</div><div class="line"></div><div class="line"> @param audios 音频地址</div><div class="line"> @param timeRanges 截取时间（数组可为空：默认视为音频的起止时间，若不为空，则必须传入与audios数量相等的time）CMTimeRangeMake(kCMTimeZero, kCMTimeZero) 默认为起止时间</div><div class="line"> @param successBlcok 成功回调</div><div class="line"> */</div><div class="line">- (void)compositionAudios:(NSArray &lt;NSURL*&gt;*)audios timeRanges:(NSArray&lt;NSValue *&gt; *)timeRanges success:(SuccessBlcok)successBlcok;</div><div class="line"></div><div class="line"></div><div class="line">/**</div><div class="line"> 多个视频合成</div><div class="line"></div><div class="line"> @param videos 视频地址</div><div class="line"> @param timeRanges 截取时间（数组可为空：默认视为视频的起止时间，若不为空，则必须传入与audios数量相等的time）CMTimeRangeMake(kCMTimeZero, kCMTimeZero) 默认为起止时间</div><div class="line"> @param successBlcok 成功回调</div><div class="line"> */</div><div class="line">- (void)compositionVideos:(NSArray &lt;NSURL*&gt;*)videos timeRanges:(NSArray&lt;NSValue *&gt; *)timeRanges success:(SuccessBlcok)successBlcok;</div><div class="line">@end</div></pre></td></tr></table></figure></p>
<p>实现代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div></pre></td><td class="code"><pre><div class="line">- (NSString *)compositionPath</div><div class="line">&#123;</div><div class="line">    return [GLFolderManager createCacheFilePath:kCompositionPath];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)compositionVideoUrl:(NSURL *)videoUrl videoTimeRange:(CMTimeRange)videoTimeRange audioUrl:(NSURL *)audioUrl audioTimeRange:(CMTimeRange)audioTimeRange success:(SuccessBlcok)successBlcok</div><div class="line">&#123;</div><div class="line">    NSCAssert(_compositionName.length &gt; 0, @&quot;请输入转换后的名字&quot;);</div><div class="line">    NSString *outPutFilePath = [[self compositionPath] stringByAppendingPathComponent:_compositionName];</div><div class="line">    </div><div class="line">    //存在该文件</div><div class="line">    if ([GLFolderManager fileExistsAtPath:outPutFilePath]) &#123;</div><div class="line">        [GLFolderManager clearCachesWithFilePath:outPutFilePath];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // 创建可变的音视频组合</div><div class="line">    AVMutableComposition *composition = [AVMutableComposition composition];</div><div class="line">    // 音频通道</div><div class="line">    AVMutableCompositionTrack *audioTrack = [composition addMutableTrackWithMediaType:AVMediaTypeAudio preferredTrackID:kCMPersistentTrackID_Invalid];</div><div class="line">    // 视频通道 枚举 kCMPersistentTrackID_Invalid = 0</div><div class="line">    AVMutableCompositionTrack *videoTrack = nil;</div><div class="line">    </div><div class="line">    </div><div class="line">    // 视频采集</div><div class="line">    AVURLAsset *videoAsset = [[AVURLAsset alloc] initWithURL:videoUrl options:nil];</div><div class="line">    </div><div class="line">    videoTimeRange = [self fitTimeRange:videoTimeRange avUrlAsset:videoAsset];</div><div class="line">    </div><div class="line">    // 音频采集</div><div class="line">    AVURLAsset *audioAsset = [[AVURLAsset alloc] initWithURL:audioUrl options:nil];</div><div class="line">    </div><div class="line">    audioTimeRange = [self fitTimeRange:audioTimeRange avUrlAsset:audioAsset];</div><div class="line"></div><div class="line">    </div><div class="line">    if (_compositionType == VideoAudioToVideo) &#123;</div><div class="line">        //以视频时间为标准 若视频时间小于音频时间 则让音频时间和视频时间保持一致</div><div class="line">        if (CMTimeCompare(videoTimeRange.duration,audioTimeRange.duration))</div><div class="line">        &#123;</div><div class="line">            audioTimeRange.duration = videoTimeRange.duration;</div><div class="line">        &#125;</div><div class="line">        //在测试中发现 VideoAudioToAudio如果不用 视频通道  就不要去创建 否则会失败</div><div class="line">        videoTrack = [composition addMutableTrackWithMediaType:AVMediaTypeVideo preferredTrackID:kCMPersistentTrackID_Invalid];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    </div><div class="line"></div><div class="line">    // 音频采集通道</div><div class="line">    AVAssetTrack *audioAssetTrack = [[audioAsset tracksWithMediaType:AVMediaTypeAudio] firstObject];</div><div class="line">    // 加入合成轨道之中</div><div class="line">    [audioTrack insertTimeRange:audioTimeRange ofTrack:audioAssetTrack atTime:kCMTimeZero error:nil];</div><div class="line"></div><div class="line">    </div><div class="line">    switch (_compositionType) &#123;</div><div class="line">        case VideoAudioToAudio:</div><div class="line">        &#123;</div><div class="line">            //  音频采集通道</div><div class="line">            AVAssetTrack *videoAssetTrack = [[videoAsset tracksWithMediaType:AVMediaTypeAudio] firstObject];</div><div class="line">            //  把采集轨道数据加入到可变轨道之中</div><div class="line">            [audioTrack insertTimeRange:videoTimeRange ofTrack:videoAssetTrack atTime:audioTimeRange.duration error:nil];</div><div class="line">        &#125;</div><div class="line">            break;</div><div class="line">        case VideoAudioToVideo:&#123;</div><div class="line"></div><div class="line">            //  视频采集通道</div><div class="line">            AVAssetTrack *videoAssetTrack = [[videoAsset tracksWithMediaType:AVMediaTypeVideo] firstObject];</div><div class="line">            //  把采集轨道数据加入到可变轨道之中</div><div class="line">            [videoTrack insertTimeRange:videoTimeRange ofTrack:videoAssetTrack atTime:kCMTimeZero error:nil];</div><div class="line">        &#125;</div><div class="line">            break;</div><div class="line">        default:</div><div class="line">            break;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    [self composition:composition storePath:outPutFilePath success:successBlcok];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)compositionVideoUrl:(NSURL *)videoUrl videoTimeRange:(CMTimeRange)videoTimeRange mergeVideoUrl:(NSURL *)mergeVideoUrl mergeVideoTimeRange:(CMTimeRange)mergeVideoTimeRange success:(SuccessBlcok)successBlcok</div><div class="line">&#123;</div><div class="line">    switch (_compositionType) &#123;</div><div class="line">        case VideoToVideo:</div><div class="line">        &#123;</div><div class="line">            NSArray *timeRanges = [NSArray arrayWithObjects:[NSValue valueWithCMTimeRange:videoTimeRange],[NSValue valueWithCMTimeRange:mergeVideoTimeRange] ,nil];</div><div class="line">            [self compositionVideos:@[videoUrl,mergeVideoUrl] timeRanges:timeRanges success:successBlcok];</div><div class="line">        &#125;</div><div class="line">            break;</div><div class="line">        case VideoToAudio:&#123;</div><div class="line">            NSArray *timeRanges = [NSArray arrayWithObjects:[NSValue valueWithCMTimeRange:videoTimeRange],[NSValue valueWithCMTimeRange:mergeVideoTimeRange] ,nil];</div><div class="line">            [self compositionAudios:@[videoUrl,mergeVideoUrl] timeRanges:timeRanges success:successBlcok];</div><div class="line">        &#125;</div><div class="line">            break;</div><div class="line">        default:</div><div class="line">            break;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)compositionVideos:(NSArray&lt;NSURL *&gt; *)videos timeRanges:(NSArray&lt;NSValue *&gt; *)timeRanges success:(SuccessBlcok)successBlcok</div><div class="line">&#123;</div><div class="line">    [self compositionMedia:videos timeRanges:timeRanges type:0 success:successBlcok];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)compositionAudios:(NSArray&lt;NSURL *&gt; *)audios timeRanges:(NSArray&lt;NSValue *&gt; *)timeRanges success:(SuccessBlcok)successBlcok</div><div class="line">&#123;</div><div class="line">    [self compositionMedia:audios timeRanges:timeRanges type:1 success:successBlcok];</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">#pragma mark == private method</div><div class="line">- (void)compositionMedia:(NSArray&lt;NSURL *&gt; *)media timeRanges:(NSArray&lt;NSValue *&gt; *)timeRanges type:(NSInteger)type success:(SuccessBlcok)successBlcok</div><div class="line">&#123;</div><div class="line">    NSCAssert(_compositionName.length &gt; 0, @&quot;请输入转换后的名字&quot;);</div><div class="line">    NSCAssert((timeRanges.count == 0 || timeRanges.count == media.count), @&quot;请输入正确的timeRange&quot;);</div><div class="line">    NSString *outPutFilePath = [[self compositionPath] stringByAppendingPathComponent:_compositionName];</div><div class="line">   </div><div class="line">    //存在该文件</div><div class="line">    if ([GLFolderManager fileExistsAtPath:outPutFilePath]) &#123;</div><div class="line">        [GLFolderManager clearCachesWithFilePath:outPutFilePath];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 创建可变的音视频组合</div><div class="line">    AVMutableComposition *composition = [AVMutableComposition composition];</div><div class="line">    if (type == 0) &#123;</div><div class="line">        // 视频通道</div><div class="line">        AVMutableCompositionTrack *videoTrack = [composition addMutableTrackWithMediaType:AVMediaTypeVideo preferredTrackID:kCMPersistentTrackID_Invalid];</div><div class="line">        // 音频通道</div><div class="line">        AVMutableCompositionTrack *audioTrack = [composition addMutableTrackWithMediaType:AVMediaTypeAudio preferredTrackID:kCMPersistentTrackID_Invalid];</div><div class="line">        </div><div class="line">        CMTime atTime = kCMTimeZero;</div><div class="line">        </div><div class="line">        for (int i = 0;i &lt; media.count;i ++) &#123;</div><div class="line">            NSURL *url = media[i];</div><div class="line">            CMTimeRange timeRange = CMTimeRangeMake(kCMTimeZero, kCMTimeZero);</div><div class="line">            if (timeRanges.count &gt; 0) &#123;</div><div class="line">                timeRange = [timeRanges[i] CMTimeRangeValue];</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            // 视频采集</div><div class="line">            AVURLAsset *videoAsset = [[AVURLAsset alloc] initWithURL:url options:nil];</div><div class="line">            timeRange = [self fitTimeRange:timeRange avUrlAsset:videoAsset];</div><div class="line">            </div><div class="line">            // 视频采集通道</div><div class="line">            AVAssetTrack *videoAssetTrack = [[videoAsset tracksWithMediaType:AVMediaTypeVideo] firstObject];</div><div class="line">            // 把采集轨道数据加入到可变轨道之中</div><div class="line">            [videoTrack insertTimeRange:timeRange ofTrack:videoAssetTrack atTime:atTime error:nil];</div><div class="line">            </div><div class="line">            // 音频采集通道</div><div class="line">            AVAssetTrack *audioAssetTrack = [[videoAsset tracksWithMediaType:AVMediaTypeAudio] firstObject];</div><div class="line">            // 加入合成轨道之中</div><div class="line">            [audioTrack insertTimeRange:timeRange ofTrack:audioAssetTrack atTime:atTime error:nil];</div><div class="line">            </div><div class="line">            atTime = CMTimeAdd(atTime, timeRange.duration);</div><div class="line">        &#125;</div><div class="line">    &#125;else&#123;</div><div class="line">        // 音频通道</div><div class="line">        AVMutableCompositionTrack *audioTrack = [composition addMutableTrackWithMediaType:AVMediaTypeAudio preferredTrackID:kCMPersistentTrackID_Invalid];</div><div class="line">        </div><div class="line">        CMTime atTime = kCMTimeZero;</div><div class="line">        </div><div class="line">        for (int i = 0;i &lt; media.count;i ++) &#123;</div><div class="line">            NSURL *url = media[i];</div><div class="line">            CMTimeRange timeRange = CMTimeRangeMake(kCMTimeZero, kCMTimeZero);</div><div class="line">            if (timeRanges.count &gt; 0) &#123;</div><div class="line">                timeRange = [timeRanges[i] CMTimeRangeValue];</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            // 音频采集</div><div class="line">            AVURLAsset *audioAsset = [[AVURLAsset alloc] initWithURL:url options:nil];</div><div class="line">            timeRange = [self fitTimeRange:timeRange avUrlAsset:audioAsset];</div><div class="line">            </div><div class="line">            // 音频采集通道</div><div class="line">            AVAssetTrack *audioAssetTrack = [[audioAsset tracksWithMediaType:AVMediaTypeAudio] firstObject];</div><div class="line">            // 加入合成轨道之中</div><div class="line">            [audioTrack insertTimeRange:timeRange ofTrack:audioAssetTrack atTime:atTime error:nil];</div><div class="line">            </div><div class="line">            atTime = CMTimeAdd(atTime, timeRange.duration);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    [self composition:composition storePath:outPutFilePath success:successBlcok];</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">//得到合适的时间</div><div class="line">- (CMTimeRange)fitTimeRange:(CMTimeRange)timeRange avUrlAsset:(AVURLAsset *)avUrlAsset</div><div class="line">&#123;</div><div class="line">    CMTimeRange fitTimeRange = timeRange;</div><div class="line">    </div><div class="line">    if (CMTimeCompare(avUrlAsset.duration,timeRange.duration))</div><div class="line">    &#123;</div><div class="line">        fitTimeRange.duration = avUrlAsset.duration;</div><div class="line">    &#125;</div><div class="line">    if (CMTimeCompare(timeRange.duration,kCMTimeZero))</div><div class="line">    &#123;</div><div class="line">        fitTimeRange.duration = avUrlAsset.duration;</div><div class="line">    &#125;</div><div class="line">    return fitTimeRange;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//输出</div><div class="line">- (void)composition:(AVMutableComposition *)avComposition</div><div class="line">          storePath:(NSString *)storePath</div><div class="line">            success:(SuccessBlcok)successBlcok</div><div class="line">&#123;</div><div class="line">    // 创建一个输出</div><div class="line">    AVAssetExportSession *assetExport = [[AVAssetExportSession alloc] initWithAsset:avComposition presetName:AVAssetExportPresetHighestQuality];</div><div class="line">    assetExport.outputFileType = AVFileTypeQuickTimeMovie;</div><div class="line">    // 输出地址</div><div class="line">    assetExport.outputURL = [NSURL fileURLWithPath:storePath];</div><div class="line">    // 优化</div><div class="line">    assetExport.shouldOptimizeForNetworkUse = YES;</div><div class="line">    </div><div class="line">    __block NSTimer *timer = nil;</div><div class="line"></div><div class="line">    timer = [NSTimer scheduledTimerWithTimeInterval:0.05 repeats:YES block:^(NSTimer * _Nonnull timer) &#123;</div><div class="line">        NSLog(@&quot; 打印信息:%f&quot;,assetExport.progress);</div><div class="line">        if (self.progressBlock) &#123;</div><div class="line">            self.progressBlock(assetExport.progress);</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line"></div><div class="line"></div><div class="line">    // 合成完毕</div><div class="line">    [assetExport exportAsynchronouslyWithCompletionHandler:^&#123;</div><div class="line">        if (timer) &#123;</div><div class="line">            [timer invalidate];</div><div class="line">            timer = nil;</div><div class="line">        &#125;</div><div class="line">        // 回到主线程</div><div class="line">        switch (assetExport.status) &#123;</div><div class="line">            case AVAssetExportSessionStatusUnknown:</div><div class="line">                NSLog(@&quot;exporter Unknow&quot;);</div><div class="line">                break;</div><div class="line">            case AVAssetExportSessionStatusCancelled:</div><div class="line">                NSLog(@&quot;exporter Canceled&quot;);</div><div class="line">                break;</div><div class="line">            case AVAssetExportSessionStatusFailed:</div><div class="line">                NSLog(@&quot;%@&quot;, [NSString stringWithFormat:@&quot;exporter Failed%@&quot;,assetExport.error.description]);</div><div class="line">                break;</div><div class="line">            case AVAssetExportSessionStatusWaiting:</div><div class="line">                NSLog(@&quot;exporter Waiting&quot;);</div><div class="line">                break;</div><div class="line">            case AVAssetExportSessionStatusExporting:</div><div class="line">                NSLog(@&quot;exporter Exporting&quot;);</div><div class="line">                break;</div><div class="line">            case AVAssetExportSessionStatusCompleted:</div><div class="line">                NSLog(@&quot;exporter Completed&quot;);</div><div class="line">                dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">                    // 调用播放方法</div><div class="line">                    successBlcok([NSURL fileURLWithPath:storePath]);</div><div class="line">                &#125;);</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在该类中涉及的都是一些简单的音频与视频的合成，代码其实并不负复杂，难点就在于对涉及的类的理解与运用上面。针对上面的代码，就简单分析下。</p>
<p><code>AVAsset</code>：应该指对应资源的资源信息<br><code>AVURLAsset</code>：继承自<code>AVAsset</code>，获取对应资源的资源信息，如获取视频或者音频的信息<br><code>AVMutableComposition</code> ：继承自<code>AVComposition</code>，而<code>AVComposition</code>继承自<code>AVAsset</code>，应该是专门用来合成音视频的合成器<br><code>AVMutableCompositionTrack</code> ：继承自<code>AVCompositionTrack</code>，而<code>AVCompositionTrack</code>继承自<code>AVAssetTrack</code>，表示资源文件中的轨道，有音频轨、视频轨等，里面可以插入各种对应的素材；<br><code>AVAssetTrack</code>：素材资源的相关轨道<br><code>AVAssetExportSession</code>：配置相应的渲染并进行输出<br>1、我们先从输出端一步一步看：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (nullable instancetype)initWithAsset:(AVAsset *)asset presetName:(NSString *)presetName</div></pre></td></tr></table></figure></p>
<p>上面是<code>AVAssetExportSession</code>的初始化函数，走初始化函数中，我们可以看到必须要有一个<code>AVAsset</code>对象，<code>presetName</code>为输出的质量，如下这些<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">AVF_EXPORT NSString *const AVAssetExportPresetLowQuality         NS_AVAILABLE(10_11, 4_0);</div><div class="line">AVF_EXPORT NSString *const AVAssetExportPresetMediumQuality      NS_AVAILABLE(10_11, 4_0);</div><div class="line">AVF_EXPORT NSString *const AVAssetExportPresetHighestQuality     NS_AVAILABLE(10_11, 4_0);</div></pre></td></tr></table></figure></p>
<p><code>AVMutableComposition</code>则继承自<code>AVAsset</code>，并且是用来合成视频音频的，所以我们完全可以通过输入该对象来实现音视频的合成。</p>
<p>2、在合成器<code>AVMutableComposition</code>有了之后，我们就需要向其中添加我们需要合成的音频或者视频通道了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">AVMutableCompositionTrack *audioTrack = [composition addMutableTrackWithMediaType:AVMediaTypeAudio preferredTrackID:kCMPersistentTrackID_Invalid];</div></pre></td></tr></table></figure></p>
<p>其中<code>AVMediaTypeAudio</code>代表音频通道，<code>AVMediaTypeVideo</code>为视频通道。<br>3、在音视频通道有了之后，我们需要获取我们需要插入的音视频资源<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">// 音频采集</div><div class="line">AVURLAsset *audioAsset = [[AVURLAsset alloc] initWithURL:audioUrl options:nil];</div><div class="line"></div><div class="line">// 音频采集通道</div><div class="line">AVAssetTrack *audioAssetTrack = [[audioAsset tracksWithMediaType:AVMediaTypeAudio] firstObject];</div></pre></td></tr></table></figure></p>
<p>4、在资源采集后，我们需要将其插入我们的音频或者视频通道中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//  把采集轨道数据加入到可变轨道之中</div><div class="line">[audioTrack insertTimeRange:videoTimeRange ofTrack:videoAssetTrack atTime:audioTimeRange.duration error:nil];</div></pre></td></tr></table></figure></p>
<p>5、输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">// 合成完毕</div><div class="line">[assetExport exportAsynchronouslyWithCompletionHandler:^&#123;</div><div class="line">    if (timer) &#123;</div><div class="line">        [timer invalidate];</div><div class="line">        timer = nil;</div><div class="line">    &#125;</div><div class="line">    // 回到主线程</div><div class="line">    switch (assetExport.status) &#123;</div><div class="line">        case AVAssetExportSessionStatusUnknown:</div><div class="line">            NSLog(@&quot;exporter Unknow&quot;);</div><div class="line">            break;</div><div class="line">        case AVAssetExportSessionStatusCancelled:</div><div class="line">            NSLog(@&quot;exporter Canceled&quot;);</div><div class="line">            break;</div><div class="line">        case AVAssetExportSessionStatusFailed:</div><div class="line">            NSLog(@&quot;%@&quot;, [NSString stringWithFormat:@&quot;exporter Failed%@&quot;,assetExport.error.description]);</div><div class="line">            break;</div><div class="line">        case AVAssetExportSessionStatusWaiting:</div><div class="line">            NSLog(@&quot;exporter Waiting&quot;);</div><div class="line">            break;</div><div class="line">        case AVAssetExportSessionStatusExporting:</div><div class="line">            NSLog(@&quot;exporter Exporting&quot;);</div><div class="line">            break;</div><div class="line">        case AVAssetExportSessionStatusCompleted:</div><div class="line">            NSLog(@&quot;exporter Completed&quot;);</div><div class="line">            dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">                // 调用播放方法</div><div class="line">                successBlcok([NSURL fileURLWithPath:storePath]);</div><div class="line">            &#125;);</div><div class="line">            break;</div><div class="line">    &#125;</div><div class="line">&#125;];</div></pre></td></tr></table></figure></p>
<p>注：在合成中还涉及的有<code>time</code>，这里就不细讲了，为了规避我们自己设置的时间超出了音视频本身的时间长度，这里我稍微做了下处理，过滤了下时间<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">//得到合适的时间</div><div class="line">- (CMTimeRange)fitTimeRange:(CMTimeRange)timeRange avUrlAsset:(AVURLAsset *)avUrlAsset</div><div class="line">&#123;</div><div class="line">    CMTimeRange fitTimeRange = timeRange;</div><div class="line">    </div><div class="line">    if (CMTimeCompare(avUrlAsset.duration,timeRange.duration))</div><div class="line">    &#123;</div><div class="line">        fitTimeRange.duration = avUrlAsset.duration;</div><div class="line">    &#125;</div><div class="line">    if (CMTimeCompare(timeRange.duration,kCMTimeZero))</div><div class="line">    &#123;</div><div class="line">        fitTimeRange.duration = avUrlAsset.duration;</div><div class="line">    &#125;</div><div class="line">    return fitTimeRange;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="分割线"><a href="#分割线" class="headerlink" title="分割线"></a>分割线</h5><p>上面是简单的音视频的合成，有走视频中提取音频然后和其它音频进行合成，也有音频与音频的合成，视频与视频的合成….大概如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">typedef NS_ENUM(NSInteger,CompositionType) &#123;</div><div class="line">    VideoToVideo = 0,//视频加视频频-视频（可细分）</div><div class="line">    VideoToAudio,//视频加视频-音频</div><div class="line">    VideoAudioToVideo,//视频加音频-视频</div><div class="line">    VideoAudioToAudio,//视频加音频-音频</div><div class="line">    AudioToAudio,//音频加音频-音频</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>由于思路都差不多，只是需要进行提取对应的音频通道或者视频通道，然后进行时间的设置和进行对应的合并，所以这里就不在多讲，下面让我们继续往下看，看看<code>视频水印</code>、<code>图片合成视频</code>、<code>视频截图</code>等稍微复杂点的功能。</p>
<h5 id="来，继续看"><a href="#来，继续看" class="headerlink" title="来，继续看"></a>来，继续看</h5><p>针对这些功能，我又建了一个类，来单独处理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">@interface VideoAudioEdit : NSObject</div><div class="line"></div><div class="line">/**</div><div class="line"> 进度block</div><div class="line"> */</div><div class="line">@property (nonatomic,copy)CompositionProgress progressBlock;</div><div class="line"></div><div class="line">/**</div><div class="line"> 截取视频某时刻的画面</div><div class="line"></div><div class="line"> @param videoUrl 视频地址</div><div class="line"> @param requestedTimes cmtime 数组</div><div class="line"> */</div><div class="line">- (void)getThumbImageOfVideo:(NSURL *_Nonnull)videoUrl forTimes:(NSArray&lt;NSValue *&gt; *_Nonnull)requestedTimes complete:(CompleteBlock _Nullable )complete;</div><div class="line"></div><div class="line"></div><div class="line">/**</div><div class="line"> 将图片合成为视频</div><div class="line"></div><div class="line"> @param images 图片数组</div><div class="line"> @param videoName 视频名字</div><div class="line"> @param successBlcok 视频地址</div><div class="line"> */</div><div class="line">- (void)compositionVideoWithImage:(NSArray &lt;UIImage *&gt;*_Nonnull)images videoName:(NSString *_Nonnull)videoName success:(SuccessBlcok _Nullable )successBlcok;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">/**</div><div class="line"> 将图片合成为视频 并加上音乐</div><div class="line"></div><div class="line"> @param images 图片数组</div><div class="line"> @param videoName 视频名字</div><div class="line"> @param audioUrl 音频地砖</div><div class="line"> @param successBlcok 返回视频地址</div><div class="line"> */</div><div class="line">- (void)compositionVideoWithImage:(NSArray &lt;UIImage *&gt;*_Nonnull)images videoName:(NSString *_Nonnull)videoName audio:(NSURL*_Nullable)audioUrl success:(SuccessBlcok _Nullable )successBlcok;</div><div class="line"></div><div class="line"></div><div class="line">/**</div><div class="line"> 视频水印</div><div class="line"></div><div class="line"> @param videoUrl 视频地址</div><div class="line"> @param videoName 视频名字</div><div class="line"> @param successBlcok 返回</div><div class="line"> */</div><div class="line">- (void)watermarkForVideo:(NSURL *_Nonnull)videoUrl videoName:(NSString *_Nonnull)videoName success:(SuccessBlcok _Nullable )successBlcok;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure></p>
<h5 id="截取视频某时刻的画面"><a href="#截取视频某时刻的画面" class="headerlink" title="截取视频某时刻的画面"></a>截取视频某时刻的画面</h5><p>这个应该是最简单的，先直接上源码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">- (void)getThumbImageOfVideo:(NSURL *)videoUrl forTimes:(NSArray&lt;NSValue *&gt; *)requestedTimes complete:(CompleteBlock)complete</div><div class="line">&#123;</div><div class="line">    AVURLAsset *asset = [[AVURLAsset alloc] initWithURL:videoUrl options:nil];</div><div class="line">    AVAssetImageGenerator *assetImage = [[AVAssetImageGenerator alloc] initWithAsset:asset];</div><div class="line">    //精确截取时间</div><div class="line">    assetImage.requestedTimeToleranceAfter = kCMTimeZero;</div><div class="line">    assetImage.requestedTimeToleranceBefore = kCMTimeZero;</div><div class="line">    assetImage.apertureMode = AVAssetImageGeneratorApertureModeEncodedPixels;</div><div class="line">    //设置最大尺寸</div><div class="line">    assetImage.maximumSize = CGSizeMake(640, 400);</div><div class="line"></div><div class="line">    //requestedTime 请求时间 actualTime实际截取画面的时间</div><div class="line">    [assetImage generateCGImagesAsynchronouslyForTimes:requestedTimes completionHandler:^(CMTime requestedTime, CGImageRef  _Nullable image, CMTime actualTime, AVAssetImageGeneratorResult result, NSError * _Nullable error) &#123;</div><div class="line">        </div><div class="line">        if (AVAssetImageGeneratorSucceeded == result) &#123;</div><div class="line">            if (image) &#123;</div><div class="line">                dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">                    UIImage *result_image = [[UIImage alloc] initWithCGImage:image];</div><div class="line">                                        </div><div class="line">                    complete(result_image,nil);</div><div class="line">                    //需要释放</div><div class="line">                    CGImageRelease(image);</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">            //展示时间</div><div class="line">            CMTimeShow(requestedTime);</div><div class="line">            CMTimeShow(actualTime);</div><div class="line"></div><div class="line">        &#125;else&#123;</div><div class="line">            dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">                complete(nil,error);</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先我们需要用到的类为<code>AVAssetImageGenerator</code><br><code>AVAssetImageGenerator</code>： 是用来提供视频的缩略图或预览视频的帧的类.<br>通过该类，我们可以获取视频的所有帧，那么在获取你想要的帧，那肯定不是什么难事了。<br>这里有几个参数<br><code>requestedTimeToleranceAfter</code>和<code>requestedTimeToleranceBefore</code>：应该是指截图图片帧真实时间的一个浮动值，当然为了达到我们想要的时间，建议设置为<code>0</code>.<br><code>maximumSize</code>：设置图片的尺寸<br>在设置后完成后，就可以直接调用函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (void)generateCGImagesAsynchronouslyForTimes:(NSArray&lt;NSValue *&gt; *)requestedTimes completionHandler:(AVAssetImageGeneratorCompletionHandler)handler;</div></pre></td></tr></table></figure></p>
<h5 id="图片合成为视频"><a href="#图片合成为视频" class="headerlink" title="图片合成为视频"></a>图片合成为视频</h5><h6 id="先上个图"><a href="#先上个图" class="headerlink" title="先上个图"></a>先上个图</h6><p><img src="https://upload-images.jianshu.io/upload_images/2525768-48338395550fc455.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="样图.jpg"></p>
<p>我们先来了解下<code>AVAssetWriter</code>类：<br><code>AVAssetWriter</code>类将媒体数据从多个源写入指定文件格式的单个文件。不需要将<code>asset writer</code>对象与特定的<code>asset</code>相关联，但必须为要创建的每个输出文件使用单独的<code>asset writer</code>。由于<code>asset writer</code>可以从多个源写入媒体数据，因此必须要为写入文件的每个track创建一个<code>AVAssetWriterInput</code>对象，每个<code>AVAssetWriterInput</code>期望以<code>CMSampleBufferRef</code>对象形式接收数据，但如果你想要将<code>CVPixelBufferRef</code>类型对象添加到<code>asset writer input</code>，就需要使用<code>AVAssetWriterInputPixelBufferAdaptor</code>类。</p>
<p><code>AVAssetWriter</code>用于对媒体资源进行编码并将其写入到容器文件中，比如一个<code>MPEG-4</code>文件或<code>QuickTime</code>文件。它由一个或多个<code>AVAssetWriterInput</code>对象配置，用于附加将包含要写入容器的媒体样本的<code>CMSampleBufferRef</code>对象。<code>AVAssetWriterInput</code>被配置为可以处理指定的媒体类型，比如音频或视频，并且附加在其后的样本会在最终输出时生成一个独立的<code>AVAssetTrack</code>。当使用一个配置了处理视频样本<code>AVAssetWriterInput</code>时，开发者会经常用到一个专门的适配器对象<code>AVAssetWriterInputPixelBufferAdaptor</code>。这个类在附加被包装为<code>CVPixelBufferRef</code>对象的视频样本是提供最优性能。输入信息也可以通过使用<a href="https://developer.apple.com/documentation/avfoundation/avassetwriterinputgroup" target="_blank" rel="external">AVAssetWriterInputGroup</a>组成互斥的参数。这就让开发者能够创建特定资源，其中包含在播放时使用<a href="https://developer.apple.com/documentation/avfoundation/avmediaselectiongroup" target="_blank" rel="external">AVMediaSelectionGroup</a>和<a href="https://developer.apple.com/documentation/avfoundation/avmediaselectionoption" target="_blank" rel="external">AVMediaSelectionOption</a>类选择的指定语言媒体轨道。</p>
<p>注意：与上面我们用到的<code>AVAssetExportSession</code>相比，<code>AVAssetWriter</code>明显的优势就是它对输出进行编码时能够进行更加细致的压缩设置控制。可以让开发者指定诸如关键帧间隔、视频比特率、H.264配置文件、像素宽高比和纯净光圈等设置</p>
<p>在有了上面的了解之后，我们就可以动手了。<br>1、创建<code>AVAssetWriter</code>对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">AVAssetWriter *assetWriter = [[AVAssetWriter alloc] initWithURL:[NSURL fileURLWithPath:outPutFilePath] fileType:AVFileTypeQuickTimeMovie error:&amp;outError];</div></pre></td></tr></table></figure></p>
<p>2、设置输出视频相关信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">//视频尺寸</div><div class="line">CGSize size = CGSizeMake(320, 480);</div><div class="line">//meaning that it must contain AVVideoCodecKey, AVVideoWidthKey, and AVVideoHeightKey.</div><div class="line">//视频信息设置</div><div class="line">NSDictionary *outPutSettingDic = [NSDictionary dictionaryWithObjectsAndKeys:</div><div class="line">                                  AVVideoCodecTypeH264,AVVideoCodecKey,</div><div class="line">                                  [NSNumber numberWithInt:size.width],AVVideoWidthKey,</div><div class="line">                                  [NSNumber numberWithInt:size.height],AVVideoHeightKey, nil];</div><div class="line"></div><div class="line">AVAssetWriterInput *videoWriterInput = [[AVAssetWriterInput alloc] initWithMediaType:AVMediaTypeVideo outputSettings:outPutSettingDic];</div></pre></td></tr></table></figure></p>
<p>3、设置输入信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">NSDictionary *sourcePixelBufferAttributes = [NSDictionary dictionaryWithObjectsAndKeys:[NSNumber numberWithInt:kCVPixelFormatType_32BGRA],kCVPixelBufferPixelFormatTypeKey, nil];</div><div class="line"></div><div class="line">AVAssetWriterInputPixelBufferAdaptor *adaptor = [AVAssetWriterInputPixelBufferAdaptor assetWriterInputPixelBufferAdaptorWithAssetWriterInput:videoWriterInput sourcePixelBufferAttributes:sourcePixelBufferAttributes];</div></pre></td></tr></table></figure></p>
<p>由于我们是图片合成为视频，所以这里采用的是<code>CVPixelBufferRef</code>添加到<code>asset writer input</code>，故使用<code>AVAssetWriterInputPixelBufferAdaptor</code>.<br>4、进行资源写入合成视频<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">//开一个队列</div><div class="line">dispatch_queue_t dispatchQueue = dispatch_queue_create(&quot;mediaQueue&quot;, NULL);</div><div class="line">NSInteger  __block index = 0;</div><div class="line"></div><div class="line">[videoWriterInput requestMediaDataWhenReadyOnQueue:dispatchQueue usingBlock:^&#123;</div><div class="line">    while ([videoWriterInput isReadyForMoreMediaData])</div><div class="line">    &#123;</div><div class="line">        if (++index &gt;= images.count * 30) &#123;</div><div class="line">            [videoWriterInput markAsFinished];</div><div class="line">            [assetWriter finishWritingWithCompletionHandler:^&#123;</div><div class="line">                dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">                    successBlcok([NSURL fileURLWithPath:outPutFilePath]);</div><div class="line">                &#125;);</div><div class="line">            &#125;];</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">        long idx = index / 30;</div><div class="line">        NSLog(@&quot; 打印信息:%ld&quot;,idx);</div><div class="line">        //先将图片转换成CVPixelBufferRef</div><div class="line">        UIImage *image = images[idx];</div><div class="line">        CVPixelBufferRef pixelBuffer = [image pixelBufferRefWithSize:size];</div><div class="line">        if (pixelBuffer) &#123;</div><div class="line">            CMTime time = CMTimeMake(index, 30);</div><div class="line">            if ([adaptor appendPixelBuffer:pixelBuffer withPresentationTime:time]) &#123;</div><div class="line">            </div><div class="line">                NSLog(@&quot;OK++%f&quot;,CMTimeGetSeconds(time));</div><div class="line">            &#125;else&#123;</div><div class="line">                NSLog(@&quot;Fail&quot;);</div><div class="line">            &#125;</div><div class="line">            CFRelease(pixelBuffer);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;];</div></pre></td></tr></table></figure></p>
<p>在上述代码中，有这么个函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (BOOL)appendPixelBuffer:(CVPixelBufferRef)pixelBuffer withPresentationTime:(CMTime)presentationTime</div></pre></td></tr></table></figure></p>
<p>该函数的功能就是添加帧，<code>presentationTime</code>代表输出文件中帧的时间，可以根据自己的需求来设置该事件。<br>注：在完成合成后，需要在主线程中进行其它操作。</p>
<h5 id="将图片合成为视频-并加上音乐"><a href="#将图片合成为视频-并加上音乐" class="headerlink" title="将图片合成为视频 并加上音乐"></a>将图片合成为视频 并加上音乐</h5><p>先上代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div></pre></td><td class="code"><pre><div class="line">- (void)compositionVideoWithImage:(NSArray&lt;UIImage *&gt; *)images videoName:(NSString *)videoName audio:(NSURL *)audioUrl success:(SuccessBlcok)successBlcok</div><div class="line">&#123;</div><div class="line">    if (!audioUrl) &#123;</div><div class="line">        [self compositionVideoWithImage:images videoName:videoName success:successBlcok];</div><div class="line">    &#125;else&#123;</div><div class="line">        NSCAssert(videoName.length &gt; 0, @&quot;请输入转换后的名字&quot;);</div><div class="line">        NSString *outPutFilePath = [[self videoPath] stringByAppendingPathComponent:videoName];</div><div class="line">        </div><div class="line">        // 音频采集</div><div class="line">        AVURLAsset *audioAsset = [[AVURLAsset alloc] initWithURL:audioUrl options:nil];</div><div class="line">        </div><div class="line">        NSString *serializationQueueDescription = [NSString stringWithFormat:@&quot;%@ serialization queue&quot;, self];</div><div class="line">        </div><div class="line">        // Create the main serialization queue.</div><div class="line">        dispatch_queue_t mainSerializationQueue = dispatch_queue_create([serializationQueueDescription UTF8String], NULL);</div><div class="line">        _m_queue = mainSerializationQueue;</div><div class="line"></div><div class="line">        [audioAsset loadValuesAsynchronouslyForKeys:@[@&quot;tracks&quot;] completionHandler:^&#123;</div><div class="line">            dispatch_async(mainSerializationQueue, ^&#123;</div><div class="line">                BOOL success = YES;</div><div class="line">                NSError *localError = nil;</div><div class="line">                // Check for success of loading the assets tracks.</div><div class="line">                success = ([audioAsset statusOfValueForKey:@&quot;tracks&quot; error:&amp;localError] == AVKeyValueStatusLoaded);</div><div class="line">                </div><div class="line">                // If the tracks loaded successfully, make sure that no file exists at the output path for the asset writer.</div><div class="line">                if (success) &#123;</div><div class="line">                    //存在该文件</div><div class="line">                    if ([GLFolderManager fileExistsAtPath:outPutFilePath]) &#123;</div><div class="line">                        [GLFolderManager clearCachesWithFilePath:outPutFilePath];</div><div class="line">                    &#125;</div><div class="line">                    </div><div class="line">                    AVAssetTrack *assetAudioTrack = nil;</div><div class="line">                    NSArray *audioTracks = [audioAsset tracksWithMediaType:AVMediaTypeAudio];</div><div class="line">                    if (audioTracks.count &gt; 0) &#123;</div><div class="line">                        assetAudioTrack = [audioTracks objectAtIndex:0];</div><div class="line">                    &#125;</div><div class="line">                    </div><div class="line">                    //音频通道是否存在</div><div class="line">                    if (assetAudioTrack)</div><div class="line">                    &#123;</div><div class="line">                        NSError *error;</div><div class="line">                        //创建读出</div><div class="line">                        AVAssetReader *assetReader = [[AVAssetReader alloc] initWithAsset:audioAsset error:&amp;error];</div><div class="line">                        BOOL success = (assetReader != nil);</div><div class="line">                        </div><div class="line">                        AVAssetWriter *assetWriter = nil;</div><div class="line">                        //创建写入</div><div class="line">                        if (success) &#123;</div><div class="line">                            NSError *outError;</div><div class="line">                            assetWriter = [[AVAssetWriter alloc] initWithURL:[NSURL fileURLWithPath:outPutFilePath] fileType:AVFileTypeQuickTimeMovie error:&amp;outError];</div><div class="line">                            success = (assetWriter != nil);</div><div class="line">                        &#125;</div><div class="line">                        if (success) &#123;</div><div class="line">                            //将track里的数据 读取出来</div><div class="line">                            // If there is an audio track to read, set the decompression settings to Linear PCM and create the asset reader output.</div><div class="line">                            NSDictionary *decompressionAudioSettings = @&#123;AVFormatIDKey : [NSNumber numberWithUnsignedInt:kAudioFormatLinearPCM]&#125;;</div><div class="line">                            AVAssetReaderTrackOutput *assetReaderAudioOutput = [AVAssetReaderTrackOutput assetReaderTrackOutputWithTrack:assetAudioTrack outputSettings:decompressionAudioSettings];</div><div class="line">                            if ([assetReader canAddOutput:assetReaderAudioOutput]) &#123;</div><div class="line">                                [assetReader addOutput:assetReaderAudioOutput];</div><div class="line">                            &#125;</div><div class="line">                            </div><div class="line">                            // Then, set the compression settings to 128kbps AAC and create the asset writer input.</div><div class="line">                            AudioChannelLayout stereoChannelLayout = &#123;</div><div class="line">                                .mChannelLayoutTag = kAudioChannelLayoutTag_Stereo,</div><div class="line">                                .mChannelBitmap = 0,</div><div class="line">                                .mNumberChannelDescriptions = 0</div><div class="line">                            &#125;;</div><div class="line">                            NSData *channelLayoutAsData = [NSData dataWithBytes:&amp;stereoChannelLayout length:offsetof(AudioChannelLayout, mChannelDescriptions)];</div><div class="line">                            NSDictionary *compressionAudioSettings = @&#123;</div><div class="line">                                                                       AVFormatIDKey         : [NSNumber numberWithUnsignedInt:kAudioFormatMPEG4AAC],</div><div class="line">                                                                       AVEncoderBitRateKey   : [NSNumber numberWithInteger:128000],</div><div class="line">                                                                       AVSampleRateKey       : [NSNumber numberWithInteger:44100],</div><div class="line">                                                                       AVChannelLayoutKey    : channelLayoutAsData,</div><div class="line">                                                                       AVNumberOfChannelsKey : [NSNumber numberWithUnsignedInteger:2]</div><div class="line">                                                                       &#125;;</div><div class="line">                            </div><div class="line">                            //将读取的内容写入</div><div class="line">                            AVAssetWriterInput *assetWriterAudioInput = [AVAssetWriterInput assetWriterInputWithMediaType:[assetAudioTrack mediaType] outputSettings:compressionAudioSettings];</div><div class="line">                            </div><div class="line">                            if ([assetWriter canAddInput:assetWriterAudioInput]) &#123;</div><div class="line">                                [assetWriter addInput:assetWriterAudioInput];</div><div class="line">                            &#125;</div><div class="line">                            </div><div class="line">                            </div><div class="line">                            //--------------图片写入视频设置</div><div class="line">                            //视频尺寸</div><div class="line">                            CGSize size = CGSizeMake(320, 480);</div><div class="line">                            //meaning that it must contain AVVideoCodecKey, AVVideoWidthKey, and AVVideoHeightKey.</div><div class="line">                            //视频信息设置</div><div class="line">                            NSDictionary *outPutSettingDic = [NSDictionary dictionaryWithObjectsAndKeys:</div><div class="line">                                                              AVVideoCodecTypeH264,AVVideoCodecKey,</div><div class="line">                                                              [NSNumber numberWithInt:size.width],AVVideoWidthKey,</div><div class="line">                                                              [NSNumber numberWithInt:size.height],AVVideoHeightKey, nil];</div><div class="line">                            </div><div class="line">                            AVAssetWriterInput *videoWriterInput = [[AVAssetWriterInput alloc] initWithMediaType:AVMediaTypeVideo outputSettings:outPutSettingDic];</div><div class="line">                            //每个AVAssetWriterInput期望以CMSampleBufferRef对象形式接收数据，但如果你想要将CVPixelBufferRef类型对象添加到assetwriterinput，就使用AVAssetWriterInputPixelBufferAdaptor类。</div><div class="line">                            </div><div class="line">                            //像素缓冲区属性，这些属性最接近于被附加的视频帧的源格式。</div><div class="line">                            //To specify the pixel format type, the pixelBufferAttributes dictionary should contain a value for kCVPixelBufferPixelFormatTypeKey</div><div class="line">                            NSDictionary *sourcePixelBufferAttributes = [NSDictionary dictionaryWithObjectsAndKeys:[NSNumber numberWithInt:kCVPixelFormatType_32BGRA],kCVPixelBufferPixelFormatTypeKey, nil];</div><div class="line">                            </div><div class="line">                            AVAssetWriterInputPixelBufferAdaptor *adaptor = [AVAssetWriterInputPixelBufferAdaptor assetWriterInputPixelBufferAdaptorWithAssetWriterInput:videoWriterInput sourcePixelBufferAttributes:sourcePixelBufferAttributes];</div><div class="line">                            </div><div class="line">                            if ([assetWriter canAddInput:videoWriterInput]) &#123;</div><div class="line">                                [assetWriter addInput:videoWriterInput];</div><div class="line">                            &#125;</div><div class="line">                            </div><div class="line">                            //--------上面为设置部分  下面为开始执行读取和写入</div><div class="line">                            </div><div class="line">                            BOOL readSuccess = YES;</div><div class="line">                            BOOL writeSuccess = YES;</div><div class="line">                            readSuccess = [assetReader startReading];</div><div class="line">                            if (!readSuccess) &#123;</div><div class="line">                                NSError *readError = assetReader.error;</div><div class="line">                                NSLog(@&quot; 打印信息:%@&quot;,readError);</div><div class="line">                            &#125;</div><div class="line">                            if (readSuccess) &#123;</div><div class="line">                                writeSuccess = [assetWriter startWriting];</div><div class="line">                            &#125;</div><div class="line">                            </div><div class="line">                            if (!writeSuccess)</div><div class="line">                            &#123;</div><div class="line">                                NSError *writeError = [assetWriter error];</div><div class="line">                                NSLog(@&quot; 打印信息:%@&quot;,writeError);</div><div class="line">                            &#125;</div><div class="line">                            if (writeSuccess)</div><div class="line">                            &#123;</div><div class="line">                                NSLog(@&quot; 打印信息:+++++&quot;);</div><div class="line">                                BOOL __block audioFinished = NO;</div><div class="line">                                BOOL __block videoFinished = NO;</div><div class="line">                                </div><div class="line">                                // If the asset reader and writer both started successfully, create the dispatch group where the reencoding will take place and start a sample-writing session.</div><div class="line">                                dispatch_group_t dispatchGroup = dispatch_group_create();</div><div class="line">                                [assetWriter startSessionAtSourceTime:kCMTimeZero];</div><div class="line">                                </div><div class="line">                                if (assetWriterAudioInput) &#123;</div><div class="line">                                    //加入第一个任务</div><div class="line">                                    // If there is audio to reencode, enter the dispatch group before beginning the work.</div><div class="line">                                    dispatch_group_enter(dispatchGroup);</div><div class="line">                                    </div><div class="line">                                    //开一个队列</div><div class="line">                                    dispatch_queue_t dispatchQueue = dispatch_queue_create(&quot;mediaAudioQueue&quot;, NULL);</div><div class="line">                                    </div><div class="line">                                    [assetWriterAudioInput requestMediaDataWhenReadyOnQueue:dispatchQueue usingBlock:^&#123;</div><div class="line">                                        // Because the block is called asynchronously, check to see whether its task is complete.</div><div class="line">                                        if (audioFinished) &#123;</div><div class="line">                                            return ;</div><div class="line">                                        &#125;</div><div class="line">                                        BOOL completedOrFailed = NO;</div><div class="line">                                        while ([assetWriterAudioInput isReadyForMoreMediaData] &amp;&amp; !completedOrFailed)</div><div class="line">                                        &#123;</div><div class="line">                                            // Get the next audio sample buffer, and append it to the output file.</div><div class="line">                                            CMSampleBufferRef sampleBuffer = [assetReaderAudioOutput copyNextSampleBuffer];</div><div class="line">                                            </div><div class="line">                                            //特别备注。。。找了几百年的bug  居然是 必须要引用assetReader.status 否则会crash</div><div class="line">                                            if ((assetReader.status == AVAssetReaderStatusReading) &amp;&amp; sampleBuffer != NULL)</div><div class="line">                                            &#123;</div><div class="line">                                                BOOL success = [assetWriterAudioInput appendSampleBuffer:sampleBuffer];</div><div class="line">                                                CFRelease(sampleBuffer);</div><div class="line">                                                sampleBuffer = NULL;</div><div class="line">                                                completedOrFailed = !success;</div><div class="line">                                            &#125;</div><div class="line">                                            else</div><div class="line">                                            &#123;</div><div class="line">                                                if (assetReader.status == AVAssetReaderStatusCompleted) &#123;</div><div class="line">                                                    completedOrFailed = YES;</div><div class="line">                                                &#125;else&#123;</div><div class="line">                                                    NSLog(@&quot; 打印信息:%@&quot;,assetReader.error);</div><div class="line">                                                    completedOrFailed = YES;</div><div class="line">                                                &#125;</div><div class="line">                                            &#125;</div><div class="line">                                            </div><div class="line">                                            </div><div class="line">                                        &#125;</div><div class="line">                                        </div><div class="line">                                        if (completedOrFailed)</div><div class="line">                                        &#123;</div><div class="line">                                            // Mark the input as finished, but only if we haven&apos;t already done so, and then leave the dispatch group (since the audio work has finished).</div><div class="line">                                            BOOL oldFinished = audioFinished;</div><div class="line">                                            audioFinished = YES;</div><div class="line">                                            if (oldFinished == NO)</div><div class="line">                                            &#123;</div><div class="line">                                                [assetWriterAudioInput markAsFinished];</div><div class="line">                                            &#125;</div><div class="line">                                            //和dispatch_group_enter成对出现 出队列</div><div class="line">                                            dispatch_group_leave(dispatchGroup);</div><div class="line">                                        &#125;</div><div class="line">                                    &#125;];</div><div class="line">                                &#125;</div><div class="line">                                </div><div class="line">                                if (videoWriterInput) &#123;</div><div class="line">                                    dispatch_group_enter(dispatchGroup);</div><div class="line">                                    dispatch_queue_t dispatchQueue = dispatch_queue_create(&quot;mediaQueue&quot;, NULL);</div><div class="line">                                    NSInteger  __block index = 0;</div><div class="line">                                    [videoWriterInput requestMediaDataWhenReadyOnQueue:dispatchQueue usingBlock:^&#123;</div><div class="line">                                        if (videoFinished) &#123;</div><div class="line">                                            return;</div><div class="line">                                        &#125;</div><div class="line">                                        while ([videoWriterInput isReadyForMoreMediaData])</div><div class="line">                                        &#123;</div><div class="line">                                            if (++index &gt;= images.count * 100) &#123;</div><div class="line">                                                [videoWriterInput markAsFinished];</div><div class="line">                                                dispatch_group_leave(dispatchGroup);</div><div class="line">                                                break;</div><div class="line">                                            &#125;</div><div class="line">                                            long idx = index / 100;</div><div class="line">                                            //先将图片转换成CVPixelBufferRef</div><div class="line">                                            UIImage *image = images[idx];</div><div class="line">                                            CVPixelBufferRef pixelBuffer = [image pixelBufferRefWithSize:size];</div><div class="line">                                            if (pixelBuffer) &#123;</div><div class="line">                                                CMTime time = CMTimeMake(index, 30);</div><div class="line">                                                if ([adaptor appendPixelBuffer:pixelBuffer withPresentationTime:time]) &#123;</div><div class="line">//                                                    NSLog(@&quot;OK++%f&quot;,CMTimeGetSeconds(time));</div><div class="line">                                                &#125;else&#123;</div><div class="line">                                                    NSLog(@&quot;Fail&quot;);</div><div class="line">                                                &#125;</div><div class="line">                                                CFRelease(pixelBuffer);</div><div class="line">                                            &#125;</div><div class="line">                                        &#125;</div><div class="line">                                    &#125;];</div><div class="line">                                &#125;</div><div class="line"></div><div class="line">                                dispatch_notify(dispatchGroup,mainSerializationQueue, ^&#123;</div><div class="line">                                        NSLog(@&quot; 打印信息:+++++++&quot;);</div><div class="line">                                    [assetWriter finishWritingWithCompletionHandler:^&#123;</div><div class="line">                                        dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">                                            successBlcok([NSURL fileURLWithPath:outPutFilePath]);</div><div class="line">                                        &#125;);</div><div class="line">                                    &#125;];</div><div class="line">                                &#125;);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个代码有点长，下面让我们一点点来了解<br>1、由于这已经不是单纯的视频音频的合并，而是涉及通过写入的方式来输出多媒体，所以我们不能再用最开始的提取音视频通道来进行简单的合并，而是需要通过写入的方式来进行<br>2、图片合成视频我们已经知道方法，如果需要将音频也写入，那么我们首先要将音频读出，所以就有了下面的方法<br>3、音频采集<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// 音频采集</div><div class="line">AVURLAsset *audioAsset = [[AVURLAsset alloc] initWithURL:audioUrl options:nil];</div></pre></td></tr></table></figure></p>
<p>4、由于多媒体文件一般比较大，获取或计算出<code>Asset</code>中的属性非常耗时，<code>apple</code>对<code>Asset</code>的属性采用了懒惰加载模式。在创建<code>AVAsset</code>的时候，只生成一个实例，并不初始化属性。只有当第一次访问属性时，系统才会根据多媒体中的数据初始化这个属性。<br>由于不用同时加载所有属性，耗时问题得到了一定缓解。但是属性加载在计算量比较大的时候仍旧可能会阻塞线程。为了解决这个问题，<code>AVFoundation</code>提供了<code>AVAsynchronousKeyValueLoading</code>协议，可以异步加载属性：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (void)loadValuesAsynchronouslyForKeys:(NSArray&lt;NSString *&gt; *)keys completionHandler:(nullable void (^)(void))handler;</div></pre></td></tr></table></figure></p>
<p>这里我们只需要知道<code>tracks</code>属性，所以<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[audioAsset loadValuesAsynchronouslyForKeys:@[@&quot;tracks&quot;] completionHandler:^&#123;</div><div class="line"></div><div class="line">&#125;];</div></pre></td></tr></table></figure></p>
<p>5、将<code>track</code>里的数据读取出来，先进行设置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">NSDictionary *decompressionAudioSettings = @&#123;AVFormatIDKey : [NSNumber numberWithUnsignedInt:kAudioFormatLinearPCM]&#125;;</div><div class="line">AVAssetReaderTrackOutput *assetReaderAudioOutput = [AVAssetReaderTrackOutput assetReaderTrackOutputWithTrack:assetAudioTrack outputSettings:decompressionAudioSettings];</div><div class="line">                     if ([assetReader canAddOutput:assetReaderAudioOutput]) &#123;</div><div class="line">                         [assetReader addOutput:assetReaderAudioOutput];</div><div class="line">                     &#125;</div></pre></td></tr></table></figure></p>
<p>6、设置输入信息，并写入音频，先进行设置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">// Then, set the compression settings to 128kbps AAC and create the asset writer input.</div><div class="line">     AudioChannelLayout stereoChannelLayout = &#123;</div><div class="line">         .mChannelLayoutTag = kAudioChannelLayoutTag_Stereo,</div><div class="line">         .mChannelBitmap = 0,</div><div class="line">         .mNumberChannelDescriptions = 0</div><div class="line">     &#125;;</div><div class="line">     NSData *channelLayoutAsData = [NSData dataWithBytes:&amp;stereoChannelLayout length:offsetof(AudioChannelLayout, mChannelDescriptions)];</div><div class="line">     NSDictionary *compressionAudioSettings = @&#123;</div><div class="line">                                                AVFormatIDKey         : [NSNumber numberWithUnsignedInt:kAudioFormatMPEG4AAC],</div><div class="line">                                                AVEncoderBitRateKey   : [NSNumber numberWithInteger:128000],</div><div class="line">                                                AVSampleRateKey       : [NSNumber numberWithInteger:44100],</div><div class="line">                                                AVChannelLayoutKey    : channelLayoutAsData,</div><div class="line">                                                AVNumberOfChannelsKey : [NSNumber numberWithUnsignedInteger:2]</div><div class="line">                                                &#125;;</div><div class="line">     </div><div class="line">     //将读取的内容写入</div><div class="line">     AVAssetWriterInput *assetWriterAudioInput = [AVAssetWriterInput assetWriterInputWithMediaType:[assetAudioTrack mediaType] outputSettings:compressionAudioSettings];</div><div class="line">     </div><div class="line">     if ([assetWriter canAddInput:assetWriterAudioInput]) &#123;</div><div class="line">         [assetWriter addInput:assetWriterAudioInput];</div><div class="line">     &#125;</div></pre></td></tr></table></figure></p>
<p>7、视频输入信息设置，不再累赘说明，代码中有详细说明<br>8、在设置完上诉信息后，我们就该进行读取和写入了，为了提高合成效率，这里我们采用异步并行执行，为了保证再两个输入都完成，这里采用了线程组的方式<code>dispatch_group_t</code>，大体步骤如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">dispatch_group_t dispatchGroup = dispatch_group_create();</div><div class="line">//加入音频写入</div><div class="line">dispatch_group_enter(dispatchGroup);</div><div class="line">...</div><div class="line">//音频写入操作</div><div class="line">...</div><div class="line">//和dispatch_group_enter成对出现 出队列</div><div class="line">dispatch_group_leave(dispatchGroup);</div><div class="line"></div><div class="line">//加入视频写入</div><div class="line">dispatch_group_enter(dispatchGroup);</div><div class="line">...</div><div class="line">//视频写入操作</div><div class="line">...</div><div class="line">//和dispatch_group_enter成对出现 出队列</div><div class="line">dispatch_group_leave(dispatchGroup);</div><div class="line"></div><div class="line"></div><div class="line">//获取结果 得到输出地址 记得在主线程中进行操作</div><div class="line">    dispatch_notify(dispatchGroup,mainSerializationQueue, ^&#123;</div><div class="line">        NSLog(@&quot; 打印信息:+++++++&quot;);</div><div class="line">        [assetWriter finishWritingWithCompletionHandler:^&#123;</div><div class="line">            dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">                successBlcok([NSURL fileURLWithPath:outPutFilePath]);</div><div class="line">            &#125;);</div><div class="line">        &#125;];</div><div class="line">    &#125;);</div></pre></td></tr></table></figure></p>
<p>在上述音频读取中，用到了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CMSampleBufferRef sampleBuffer = [assetReaderAudioOutput copyNextSampleBuffer];</div></pre></td></tr></table></figure></p>
<p><code>API</code>中是这么描述的<br><code>Copies the next sample buffer for the output synchronously.</code>大概意思就是：同步复制输出的下一个示例缓冲区，即得到我们想要的数据</p>
<h5 id="视频水印处理"><a href="#视频水印处理" class="headerlink" title="视频水印处理"></a>视频水印处理</h5><p>在水印处理之前，大家可以先看看文章上面我的手绘图，有这么几个类:<br><code>AVMutableVideoComposition</code>：用来生成<code>video</code>的组合指令，包含多段<code>instruction</code>。可以决定最终视频的尺寸，裁剪需要在这里进行；<br><code>AVMutableVideoCompositionInstruction</code>：一个指令，决定一个<code>timeRange</code>内每个轨道的状态，包含多个<code>layerInstruction</code>；<br><code>AVMutableVideoCompositionLayerInstruction</code>：在一个指令的时间范围内，某个轨道的状态； </p>
<p>先看看水印的核心代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">//创建合成指令</div><div class="line">AVMutableVideoCompositionInstruction *videoCompostionInstruction = [AVMutableVideoCompositionInstruction videoCompositionInstruction];</div><div class="line">//设置时间范围</div><div class="line">videoCompostionInstruction.timeRange = CMTimeRangeMake(kCMTimeZero, videoAssetTrack.timeRange.duration);</div><div class="line">//创建层指令，并将其与合成视频轨道相关联</div><div class="line">AVMutableVideoCompositionLayerInstruction *videoLayerInstruction = [AVMutableVideoCompositionLayerInstruction videoCompositionLayerInstructionWithAssetTrack:videoCompositionTrack];</div><div class="line"></div><div class="line">[videoLayerInstruction setTransform:videoAssetTrack.preferredTransform atTime:kCMTimeZero];</div><div class="line">[videoLayerInstruction setOpacity:0.0 atTime:videoAssetTrack.timeRange.duration];</div><div class="line">videoCompostionInstruction.layerInstructions = @[videoLayerInstruction];</div><div class="line"></div><div class="line"></div><div class="line">BOOL isVideoAssetPortrait_  = NO;</div><div class="line">CGAffineTransform videoTransform = videoAssetTrack.preferredTransform;</div><div class="line">if (videoTransform.a == 0 &amp;&amp; videoTransform.b == 1.0 &amp;&amp; videoTransform.c == -1.0 &amp;&amp; videoTransform.d == 0) &#123;</div><div class="line">    //        videoAssetOrientation_ = UIImageOrientationRight;</div><div class="line">    isVideoAssetPortrait_ = YES;</div><div class="line">&#125;</div><div class="line">if (videoTransform.a == 0 &amp;&amp; videoTransform.b == -1.0 &amp;&amp; videoTransform.c == 1.0 &amp;&amp; videoTransform.d == 0) &#123;</div><div class="line">    //        videoAssetOrientation_ =  UIImageOrientationLeft;</div><div class="line">    isVideoAssetPortrait_ = YES;</div><div class="line">&#125;</div><div class="line">CGSize naturalSize;</div><div class="line">if(isVideoAssetPortrait_)&#123;</div><div class="line">    naturalSize = CGSizeMake(videoAssetTrack.naturalSize.height, videoAssetTrack.naturalSize.width);</div><div class="line">&#125; else &#123;</div><div class="line">    naturalSize = videoAssetTrack.naturalSize;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//创建视频组合</div><div class="line">//Attach the video composition instructions to the video composition</div><div class="line">AVMutableVideoComposition *mutableVideoComposition = [AVMutableVideoComposition videoComposition];</div><div class="line">//必须设置 下面的尺寸和时间</div><div class="line">mutableVideoComposition.renderSize = naturalSize;</div><div class="line">mutableVideoComposition.frameDuration = CMTimeMake(1, 25);//videoAssetTrack.timeRange.duration;</div><div class="line">mutableVideoComposition.instructions = @[videoCompostionInstruction];</div><div class="line">[self addWaterLayerWithAVMutableVideoComposition:mutableVideoComposition];</div></pre></td></tr></table></figure></p>
<p>++++<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">- (void)addWaterLayerWithAVMutableVideoComposition:(AVMutableVideoComposition*)mutableVideoComposition</div><div class="line">&#123;</div><div class="line">    //-------------------layer</div><div class="line">    CALayer *watermarkLayer = [CALayer layer];</div><div class="line">    [watermarkLayer setContents:(id)[UIImage imageNamed:@&quot;白兔&quot;].CGImage];</div><div class="line">    watermarkLayer.bounds = CGRectMake(0, 0, 130, 130);</div><div class="line">    watermarkLayer.position = CGPointMake(mutableVideoComposition.renderSize.width/2, mutableVideoComposition.renderSize.height/4);</div><div class="line">    </div><div class="line">    CALayer *sheepLayer = [CALayer layer];</div><div class="line">    [sheepLayer setContents:(id)[UIImage imageNamed:@&quot;绵阳&quot;].CGImage];</div><div class="line">    sheepLayer.bounds = CGRectMake(0, 0, 130, 130);</div><div class="line">    sheepLayer.position = CGPointMake(mutableVideoComposition.renderSize.width/2, mutableVideoComposition.renderSize.height - 150);</div><div class="line">    </div><div class="line">    </div><div class="line">    CALayer *mouseLayer = [CALayer layer];</div><div class="line">    [mouseLayer setContents:(id)[UIImage imageNamed:@&quot;老鼠&quot;].CGImage];</div><div class="line">    mouseLayer.bounds = CGRectMake(0, 0, 130, 130);</div><div class="line">    mouseLayer.position = CGPointMake(mutableVideoComposition.renderSize.width/2, mutableVideoComposition.renderSize.height/2);</div><div class="line"></div><div class="line">    </div><div class="line">    CALayer *parentLayer = [CALayer layer];</div><div class="line">    CALayer *videoLayer = [CALayer layer];</div><div class="line">    </div><div class="line">    parentLayer.frame = CGRectMake(0, 0, mutableVideoComposition.renderSize.width, mutableVideoComposition.renderSize.height);</div><div class="line">    videoLayer.frame = CGRectMake(0, 0, mutableVideoComposition.renderSize.width, mutableVideoComposition.renderSize.height);</div><div class="line"></div><div class="line">    [parentLayer addSublayer:videoLayer];</div><div class="line">    </div><div class="line">    [parentLayer addSublayer:watermarkLayer];</div><div class="line">    [parentLayer addSublayer:sheepLayer];</div><div class="line">    [parentLayer addSublayer:mouseLayer];</div><div class="line">    </div><div class="line">    </div><div class="line">    //添加文字</div><div class="line">    UIFont *font = [UIFont systemFontOfSize:30.0];</div><div class="line">    NSString *text = @&quot;加点水印看看效果&quot;;</div><div class="line">    CATextLayer *textLayer = [[CATextLayer alloc] init];</div><div class="line">    [textLayer setFontSize:30];</div><div class="line">    [textLayer setString:text];</div><div class="line">    [textLayer setAlignmentMode:kCAAlignmentLeft];</div><div class="line">    [textLayer setForegroundColor:[[UIColor whiteColor] CGColor]];</div><div class="line">    </div><div class="line">    CGSize textSize = [text sizeWithAttributes:[NSDictionary dictionaryWithObjectsAndKeys:font,NSFontAttributeName, nil]];</div><div class="line">    CGFloat textH = textSize.height + 10;</div><div class="line">    [textLayer setFrame:CGRectMake(100, mutableVideoComposition.renderSize.height-100, textSize.width + 20, textH)];</div><div class="line">    </div><div class="line">    [parentLayer addSublayer:textLayer];</div><div class="line">    </div><div class="line">    mutableVideoComposition.animationTool = [AVVideoCompositionCoreAnimationTool videoCompositionCoreAnimationToolWithPostProcessingAsVideoLayer:videoLayer inLayer:parentLayer];</div><div class="line">    </div><div class="line">    CABasicAnimation *rotationAnima = [CABasicAnimation animationWithKeyPath:@&quot;transform.rotation.z&quot;];</div><div class="line">    rotationAnima.fromValue = @(0);</div><div class="line">    rotationAnima.toValue = @(-M_PI * 2);</div><div class="line">    rotationAnima.repeatCount = HUGE_VALF;</div><div class="line">    rotationAnima.duration = 2.0f;  //5s之后消失</div><div class="line">    [rotationAnima setRemovedOnCompletion:NO];</div><div class="line">    [rotationAnima setFillMode:kCAFillModeForwards];</div><div class="line">    rotationAnima.beginTime = AVCoreAnimationBeginTimeAtZero;</div><div class="line">    [watermarkLayer addAnimation:rotationAnima forKey:@&quot;Aniamtion&quot;];</div><div class="line">    </div><div class="line">    </div><div class="line">    CGPoint mousePoint = mouseLayer.position;</div><div class="line">    CAKeyframeAnimation *animation = [CAKeyframeAnimation animationWithKeyPath:@&quot;position&quot;];</div><div class="line">    NSValue *key1 = [NSValue valueWithCGPoint:mouseLayer.position];</div><div class="line">    NSValue *key2 = [NSValue valueWithCGPoint:CGPointMake(mousePoint.x + 60, mousePoint.y + 40)];</div><div class="line">    NSValue *key3 = [NSValue valueWithCGPoint:CGPointMake(mousePoint.x + 120, mousePoint.y)];</div><div class="line">    NSValue *key4 = [NSValue valueWithCGPoint:CGPointMake(mousePoint.x + 120, mousePoint.y)];</div><div class="line">    animation.values = @[key1,key2,key3,key4];</div><div class="line">    animation.duration = 5.0;</div><div class="line">    animation.autoreverses = true;//是否按路径返回</div><div class="line">    animation.repeatCount = HUGE_VALF;//是否重复执行</div><div class="line">    animation.removedOnCompletion = NO;//执行后移除动画</div><div class="line">    animation.fillMode = kCAFillModeForwards;</div><div class="line">    animation.beginTime = AVCoreAnimationBeginTimeAtZero;</div><div class="line">    [mouseLayer addAnimation:animation forKey:@&quot;keyframeAnimation_fish&quot;];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mutableVideoComposition.animationTool = [AVVideoCompositionCoreAnimationTool videoCompositionCoreAnimationToolWithPostProcessingAsVideoLayer:videoLayer inLayer:parentLayer];</div></pre></td></tr></table></figure></p>
<p>则是设置水印的关键一步，这边将我们想要设置的水印<code>layer</code>添加到我们想要的视频中，其他关于<code>AVMutableVideoCompositionInstruction</code>和<code>AVMutableVideoCompositionLayerInstruction</code>的设置均是对视频的一些设置，可以有很多设置，大家有时间可以去了解下，我这里只是简单的设置了下。</p>
<h5 id="尾章"><a href="#尾章" class="headerlink" title="尾章"></a>尾章</h5><p>终于一口气写完，讲述的不是很详细，还请各位看官见谅！请忽略那个弹钢琴的视频…辣眼睛<br>下面还是附上<a href="https://github.com/gao211326/VideoAudioCompositionDemo" target="_blank" rel="external">传送门</a><br>由于<code>GitHub</code>上传文件的限制，导致工程中有几个视频和音频不能传上去，所以这里只好通过<a href="https://pan.baidu.com/s/1IzuPea5sXaxOVr7lyNQkVQ" target="_blank" rel="external">网盘</a>  密码:<code>mygj</code><br>将下载下来的资源放到这里面就ok了<br><img src="https://upload-images.jianshu.io/upload_images/2525768-0f052c896cda0e15.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="23.png"></p>
<p>参考文章：<a href="https://developer.apple.com/library/archive/documentation/AudioVideo/Conceptual/AVFoundationPG/Articles/05_Export.html" target="_blank" rel="external">官方文档</a></p>
</the></excerpt>
      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2018/06/13/iOS 音频视频图像合成那点事/">iOS 音频视频图像合成那点事</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">One Dream</a></p>
        <p><span>发布时间:</span>2018-06-13, 00:00:00</p>
        <p><span>最后更新:</span>2018-06-13, 14:15:23</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2018/06/13/iOS 音频视频图像合成那点事/" title="iOS 音频视频图像合成那点事">http://yoursite.com/2018/06/13/iOS 音频视频图像合成那点事/</a>
            <span class="copy-path" data-clipboard-text="原文: http://yoursite.com/2018/06/13/iOS 音频视频图像合成那点事/　　作者: One Dream" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2018/03/12/iOS 图片文字组合头像那点事/">
                    iOS 图片文字组合头像那点事
                </a>
            </div>
        
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#入场"><span class="toc-number">2.</span> <span class="toc-text">入场</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#需要了解什么"><span class="toc-number">3.</span> <span class="toc-text">需要了解什么</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#代码实现"><span class="toc-number">4.</span> <span class="toc-text">代码实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#分割线"><span class="toc-number">5.</span> <span class="toc-text">分割线</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#来，继续看"><span class="toc-number">6.</span> <span class="toc-text">来，继续看</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#截取视频某时刻的画面"><span class="toc-number">7.</span> <span class="toc-text">截取视频某时刻的画面</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#图片合成为视频"><span class="toc-number">8.</span> <span class="toc-text">图片合成为视频</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#先上个图"><span class="toc-number">8.1.</span> <span class="toc-text">先上个图</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#将图片合成为视频-并加上音乐"><span class="toc-number">9.</span> <span class="toc-text">将图片合成为视频 并加上音乐</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#视频水印处理"><span class="toc-number">10.</span> <span class="toc-text">视频水印处理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#尾章"><span class="toc-number">11.</span> <span class="toc-text">尾章</span></a></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"iOS 音频视频图像合成那点事　| 半笑半醉间　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2018/03/12/iOS 图片文字组合头像那点事/" title="上一篇: iOS 图片文字组合头像那点事">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/" title="回到主页"><i class="fa fa-home"></i></a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/06/13/iOS 音频视频图像合成那点事/">iOS 音频视频图像合成那点事</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/12/iOS 图片文字组合头像那点事/">iOS 图片文字组合头像那点事</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/14/iOS之基于FreeStreamer的简单音乐播放器/">iOS之基于FreeStreamer的简单音乐播放器</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/12/iOS 11之Vision人脸检测/">iOS 11之Vision人脸检测</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/12/iOS提取APP中的图片资源/">iOS提取APP中的图片资源</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/12/iOS Core ML与Vision初识 /">iOS Core ML与Vision初识</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/21/iOS 关于copy与mutableCopy浅析/">iOS 关于copy与mutableCopy浅析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/15/iOS __attribute__那点小事/">iOS __attribute__那点小事</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/03/Go 语言学习之struct/">Go 语言学习之struct</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/12/Go 语言学习之函数/">Go 语言学习之函数</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/06/iOS translucent引发的那点小事/">iOS translucent引发的那点小事</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/27/iOS 自定义键盘/">iOS 自定义键盘</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/25/Go 语言学习之流程控制/">Go 语言学习之流程控制</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/23/Go 语言学习之数组 字典/">Go 语言学习之数组 字典</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/22/Go 语言基础之常量 变量/">Go 语言基础之常量 变量</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/19/Go 语言之Mac环境配置/">Go 语言之Mac环境配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/12/iOS CoreImage之滤镜简单使用/">iOS CoreImage之滤镜简单使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/24/iOS UIImage常用category/">iOS Quart2D绘图之UIImage简单使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/05/iOS自定义转场动画/">iOS 自定义转场动画浅谈</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2018 One Dream
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 4;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>